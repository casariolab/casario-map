<template>
  <div id="site-wrap">
    <!-- ===DESKTOP=== -->
    <v-app
      v-if="!$vuetify.breakpoint.smAndDown"
      id="wg-app"
      data-app
      :class="{ 'wg-app': true }"
    >
      <template>
        <v-expand-transition>
          <v-navigation-drawer
            v-model="sidebarState"
            :width="
              !selectedCoorpNetworkEntity
                ? sidebarWidth.default
                : sidebarWidth.corporateNetworkSelected
            "
            class="elevation-6"
            :color="$appConfig.app.sideBar.backgroundColor"
            stateless
            app
            clipped
            right
            :style="`color:${$appConfig.app.sideBar.textColor};`"
          >
            <side-panel></side-panel>
          </v-navigation-drawer>
        </v-expand-transition>
      </template>

      <!-- APP BAR DESKTOP -->
      <v-app-bar app clipped-right height="60" :color="color.primary" dark>
        <v-toolbar-title
          @click="goToHome()"
          flat
          :style="`background-color:${color.primary};text-color:white;`"
          class="logo headline font-weight-bold gray--text mr-3 dark"
          >{{ $appConfig.app.title }}</v-toolbar-title
        >
        <v-tooltip right>
          <template v-slot:activator="{ on }">
            <v-btn
              v-on="on"
              small
              depressed
              fab
              color="gray"
              class="ml-0"
              @click="openWebsite()"
              ><v-icon small>fas fa-home</v-icon></v-btn
            > </template
          ><span>Open Website</span>
        </v-tooltip>

        <v-spacer></v-spacer>
        <div v-for="(navbarGroup, index) in navbarGroups" :key="index">
          <v-btn
            min-width="200"
            class="mx-10"
            :dark="
              activeLayerGroup.navbarGroup === navbarGroup.name ? false : true
            "
            @click="changeNavbarGroup(navbarGroup)"
            :color="
              activeLayerGroup.navbarGroup === navbarGroup.name
                ? 'white'
                : color.primary
            "
            :class="{
              'elevation-0': activeLayerGroup.navbarGroup !== navbarGroup.name,
              'font-weight-bold black--text':
                activeLayerGroup.navbarGroup === navbarGroup.name,
              'elevation-6': activeLayerGroup.navbarGroup === navbarGroup.name
            }"
          >
            {{ navbarGroup.title }}
          </v-btn>
        </div>
        <v-spacer></v-spacer><v-spacer></v-spacer>

        <!--      <span class="title pr-5">before it's too late</span>  -->
        <v-btn icon @click.stop="sidebarState = !sidebarState"
          ><v-icon medium>{{
            sidebarState ? '$close' : '$menu'
          }}</v-icon></v-btn
        >
      </v-app-bar>

      <v-content>
        <v-container style="max-height: 100%;" fluid fill-height class="pa-0">
          <app-viewer />
        </v-container>
      </v-content>
    </v-app>

    <!-- ===MOBILE=== -->
    <v-app
      data-app
      v-if="$vuetify.breakpoint.smAndDown"
      class="mobile-parent-wrap"
    >
      <!-- APP BAR MOBILE -->
      <v-app-bar :color="color.primary" height="60" absolute dark>
        <v-btn icon @click="navDrawer = !navDrawer"
          ><v-icon medium>{{ navDrawer ? '$close' : '$menu' }}</v-icon></v-btn
        >

        <v-toolbar-title>{{ title }}</v-toolbar-title>
        <v-spacer></v-spacer>
        <v-btn @click="goToHome()" icon>
          <v-icon>fas fa-home</v-icon>
        </v-btn>
      </v-app-bar>

      <!-- NAVIGATION DRAWER MOBILE -->
      <v-navigation-drawer
        style="z-index:1001;"
        v-model="navDrawer"
        absolute
        left
        temporary
      >
        <v-list nav dense class="mb-4">
          <!-- Main groups -->
          <v-list-item>
            <v-list-item-icon>
              <v-icon>map</v-icon>
            </v-list-item-icon>

            <v-list-item-content>
              <v-list-item-title class="font-weight-bold"
                >MAP</v-list-item-title
              >
            </v-list-item-content>
          </v-list-item>
          <v-divider></v-divider>
          <v-list-item
            :dark="
              activeLayerGroup.navbarGroup === navbarGroup.name ? true : false
            "
            :style="
              `background-color:${
                activeLayerGroup.navbarGroup === navbarGroup.name
                  ? color.primary
                  : 'white'
              };`
            "
            @click="changeNavbarGroup(navbarGroup)"
            v-for="(navbarGroup, index) in navbarGroups"
            :color="
              activeLayerGroup.navbarGroup === navbarGroup.name
                ? 'white'
                : color.primary
            "
            :key="index"
          >
            <v-list-item-title>{{
              navbarGroup.title.toUpperCase()
            }}</v-list-item-title>
          </v-list-item>
        </v-list>

        <!-- Sub groups  -->
        <v-list nav dense v-if="regionLength > 0">
          <v-list-item>
            <v-list-item-icon>
              <v-icon>subject</v-icon>
            </v-list-item-icon>

            <v-list-item-content>
              <v-list-item-title class="font-weight-bold"
                >SUBCATEGORY</v-list-item-title
              >
            </v-list-item-content>
          </v-list-item>
          <v-divider class="mb-4"></v-divider>
          <template v-for="(region, index) in regions">
            <v-list-item
              @click="changeRegion(region)"
              v-if="hasRegion(region)"
              :dark="activeLayerGroup.region === region.name ? true : false"
              :style="
                `background-color:${
                  activeLayerGroup.region === region.name
                    ? color.primary
                    : 'white'
                };`
              "
              :key="index"
            >
              <v-list-item-title>{{
                region.title.toUpperCase()
              }}</v-list-item-title>
            </v-list-item>
          </template>
        </v-list>
      </v-navigation-drawer>

      <app-viewer
        :style="`height: calc(${mobilePanelState ? 60 : 100}% - 60px);touch-action: none;`"
        class="mobile-map-viewer"
      ></app-viewer>

      <div class="mobile-bottom-sheet" v-show="mobilePanelState">
        <side-panel></side-panel>
        <button @click="closeAll()" class="close-btn-mobile-panel">âœ•</button>
      </div>
    </v-app>
  </div>
</template>

<script>
import { EventBus } from '../EventBus.js';
import Viewer from '../components/viewer/viewer';
import SidePanel from '../components/core/SidePanel';
//Store imports
import { mapMutations, mapGetters } from 'vuex';
import { mapFields } from 'vuex-map-fields';

export default {
  name: 'wg-app',
  props: ['navbarGroup', 'region'],
  computed: {
    ...mapFields('map', {
      selectedCoorpNetworkEntity: 'selectedCoorpNetworkEntity',
      isEditingPost: 'isEditingPost',
      isEditingHtml: 'isEditingHtml',
      postEditType: 'postEditType',
      postFeature: 'postFeature',
      popup: 'popup',
      mobilePanelState: 'mobilePanelState',
      navbarGroups: 'navbarGroups',
      regions: 'regions',
      geoserverWorkspace: 'geoserverWorkspace'
    }),
    ...mapGetters('map', {
      activeLayerGroup: 'activeLayerGroup'
    }),
    ...mapFields('app', {
      sidebarState: 'sidebarState'
    }),
    regionLength() {
      const activeNavbarGroup = this.activeLayerGroup.navbarGroup;
      const regions = this.$appConfig.map.groups[activeNavbarGroup];
      const regionsArray = Object.keys(regions).filter(v => v !== 'default');
      let count = 0;
      regionsArray.forEach(region => {
        if (regions[region].layers.length > 0) {
          count++;
        }
      });
      return count;
    },
    title() {
      const activeNavbarGroup = this.activeLayerGroup.navbarGroup;
      const activeRegion = this.activeLayerGroup.region;
      let title = ``;
      this.navbarGroups.forEach(group => {
        if (group.name === activeNavbarGroup) {
          title = group.title.toUpperCase();
        }
      });
      this.regions.forEach(region => {
        if (region.name === activeRegion && region.name !== 'default') {
          title += ` - ${region.title}`;
        }
      });
      return title;
    }
  },
  components: {
    'app-viewer': Viewer,
    'side-panel': SidePanel
  },
  data() {
    return {
      color: this.$appConfig.app.color,
      navDrawer: false,
      sidebarWidth: {
        default: 460,
        corporateNetworkSelected: 600
      }
    };
  },
  methods: {
    goToHome() {
      EventBus.$emit('resetMap');
    },
    openWebsite() {
      window.open('https://wiki.timetochange.today', '_blank');
    },
    zoomToLocation() {
      if (this.region === 'local') {
        EventBus.$emit('zoomToLocation');
      }
    },
    changeNavbarGroup(navbarGroup) {
      this.$router.push({ path: `/${navbarGroup.name}` });
      EventBus.$emit('noMapReset');
    },
    onResize() {
      const winWidth = window.innerWidth;
      let _default;
      let _corporateNetworkSelected;
      if (winWidth > 2000) {
        // Values for larger screens
        _default = 600;
        _corporateNetworkSelected = 600;
      } else if (winWidth < 900) {
        // Values for small screens (mini - tables or low resolutions)
        _default = 350;
        _corporateNetworkSelected = 350;
      } else {
        // Values for normal screens (default)
        _default = 460;
        _corporateNetworkSelected = 600;
      }
      this.sidebarWidth = {
        default: _default,
        corporateNetworkSelected: _corporateNetworkSelected
      };
    },
    changeRegion(region) {
      this.$router.push({
        path: `/${this.activeLayerGroup.navbarGroup}/${region.name}`
      });
      if (region.name === 'local') {
        EventBus.$emit('zoomToLocation');
      }
    },
    hasRegion(region) {
      const activeNavbarGroup = this.activeLayerGroup.navbarGroup;
      const regions = this.$appConfig.map.groups[activeNavbarGroup];
      if (region.name === 'default') {
        return;
      }
      if (regions[region.name] && regions[region.name].layers.length > 0) {
        return true;
      } else {
        return false;
      }
    },
    closeAll() {
      EventBus.$emit('closeAll');
      this.mobilePanelState = false;
    },
    ...mapMutations('map', {
      setActiveLayerGroup: 'SET_ACTIVE_LAYERGROUP'
    }),
    ...mapMutations('app', {
      setSidebarInitialState: 'setSidebarInitialState'
    })
  },
  created() {
    // Navgroups
    const groups = this.$appConfig.map.groups;
    const groupTitles = this.$appConfig.map.groupTitles;
    const navbarGroups = [];
    Object.keys(groups).forEach(groupName => {
      navbarGroups.push({
        name: groupName,
        title: groupTitles[groupName] || groupName
      });
    });
    this.navbarGroups = navbarGroups;
    // Regions
    const regionTitles = this.$appConfig.map.regionTitles;
    Object.keys(regionTitles).forEach(regionName => {
      this.regions.push({
        name: regionName,
        title: regionTitles[regionName]
      });
    });

    // Geoserver workspace
    this.geoserverWorkspace = this.$appConfig.map.geoserverWorkspace;
    // Set active layer group
    this.setActiveLayerGroup({
      navbarGroup: this.navbarGroup,
      region: this.region
    });
    // Set initial state for sidebar.
    this.setSidebarInitialState(this.$appConfig.app.sideBar.isVisible);
  },
  watch: {
    $route(newValue, oldValue) {
      if (oldValue.path === newValue.path) {
        return;
      }
      this.setActiveLayerGroup({
        navbarGroup: this.navbarGroup,
        region: this.region
      });
      this.zoomToLocation();
      // Activate mobile panel state
      this.$nextTick(() => {
        this.mobilePanelState = true;
      });
    },
    postFeature(feature) {
      if (feature) {
        this.mobilePanelState = true;
      } else {
        this.mobilePanelState = false;
      }
    },
    isEditingHtml(state) {
      this.mobilePanelState = state;
    },
    isEditingPost() {
      this.mobilePanelState = false;
    },
    postEditType(state) {
      if (state === 'update') {
        this.mobilePanelState = true;
      }
    },
    'popup.activeFeature': function(feature) {
      if (feature) {
        this.mobilePanelState = true;
      } else {
        this.mobilePanelState = false;
      }
    }
  },
  mounted() {
    // inform registered cmps that the app is mounted and the dynamic
    // components are available
    EventBus.$emit('app-mounted');
    this.onResize();
    window.addEventListener('resize', this.onResize, { passive: true });
  },
  beforeDestroy() {
    if (typeof window === 'undefined') return;
    window.removeEventListener('resize', this.onResize, { passive: true });
  }
};
</script>
